<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <title>Statistics map</title>
    <style>
    	body {
      font-family: "Helvetica Neue", Helvetica, sans-serif;;
      font-size: 12px;
      width: 960px;
      height: 500px;
      margin: 20px auto;
      }

		.states {
    stroke: #fff;
    fill: none;
    pointer-events: none;
    }
    .counties {
    stroke: #fff;
    fill: green;
    stroke-width: .3px;
    }
    .tooltip {
    background: rgba(0, 0, 0, 0.85);
    color: #f9f9f9;
    padding: 8px;
    }
    .tooltip h3 {
    margin: 0px 0px 8px;
    }

    .state-land {
      fill: grey;
      stroke-width: 1.5px;
      stroke: white;
    }

    .county-land {
      stroke: white;
      stroke-width: .3px;
    }
    </style>
  </head>

  <body>
    <h3>Death map</h3>
    <div id="map" align = 'center'><!-- Map container --></div>
    <div id = "tooltip"></div>
    <script type="text/javascript">
    //we specify the dimensions for the map container. 

	var width = 950,
    	height = 500;
	// We create a SVG element in the map container and give it some dimensions.
	var svg = d3.select('#map').append('svg')
  				.attr('width', width)
  				.attr('height', height);
  var map = svg.append('g')
          .style('stroke-width', '1.5px');

  //set the color
  var color = d3.scaleLinear()
              //.domain([d3.min(death),d3.max(death)])
              .domain([10,100])
              .range(["#fde0dd","#fcc5c0","#fa9fb5","#f768a1","#dd3497","#ae017e","#7a0177","#49006a"]); 

  // set the tooltips for mouse hover
  var tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden");

  //A queue evaluates zero or more deferred asynchronous tasks with configurable concurrency
  d3.queue()
    .defer(d3.csv, 'police_killings.csv')
    .defer(d3.json, 'us.json')
    .await(ready);
  // We define a geographical projection and set the initial zoom to show the features.
  var projection = d3.geoAlbersUsa()
                    .scale(1080)
                    .translate([width/2, height/2]);

  var path = d3.geoPath()
               .projection(projection);

  // execute after loading the csv and us.json data
	function ready(error, deaths,topology) {
      if (error) return console.warn(error);
/*
  deathsByFips = {};
  deaths.forEach(function(d) {
    d.Deaths = +d.Deaths;
    d.Population = +d.Population;
    d["Crude Rate"] = +(d["Crude Rate"].replace(" (Unreliable)", ""));
    deathsByFips[+d["County Code"]] = d;
*/
//convert csv data to the format as mapData=[{'state':'xxxx','death':1234},{},{}...]
      var statStateDeath = {};
      //change the column in csv file to a map
      for (var i = 0; i < deaths.length; i++) {
          var state = deaths[i].state;
          if (!statStateDeath.hasOwnProperty(state)) {
              statStateDeath[state] = 1;
          } else {
              statStateDeath[state] += 1;
            }
        };

      var mapData = [];
        for (var state in statStateDeath) {
            var pair = {};
            pair['state'] = state;
            pair['death'] = statStateDeath[state];
            mapData.push(pair);
          };
//append path to map
      map.selectAll('.state-land')
         .data(topojson.feature(topology, topology.objects.states).features)
         .enter().append('path')
         .attr('d', path)
         .attr('class', 'state-land');
         //.on('click', function(state) {clickState.call(this, state, topology, countyData);
          //});

  };

  
	// We prepare a path object and apply the projection to it.
	//var path = uStates.getpath();
  /*var subset = topojson.feature(us, us.objects.counties)
              .features.filter(function(d) {
                return d.id in deathsByFips;
                });
  /*var projection = d3.geo.mercator()
  .scale(1500)
  // Center the Map in Colombia
  .center([-74, 4.5])
  .translate([width / 2, height / 2]);

var path = d3.geo.path()
  .projection(projection);*/

 /* 	function mapDataGenerate(d) {
  		var map = {};
    	//change the column in csv file to a map
    	for (var i = 0; i < d.length; i++) {
        	var state = d[i].state;
        	if (!map.hasOwnProperty(state)) {
            	map[state] = 1;
        	} else {
            	map[state] += 1;
            }
        };

    	var mapData = [];
        for (var key in map) {
            var pair = {};
            pair['state'] = key;
            pair['death'] = map[key];
            pair['path'] = '';
            mapData.push(pair);
          };
            
        return mapData;
  	};

  	function drawMap(data) {
  		var death = [];
        for (var i=0; i< data.length; i++){
            death.push(data[i].death);
        };

       var color = d3.scaleLinear()
       				.domain([d3.min(death),d3.max(death)])
       				.range(["#E9967A","#670a08"]); 

       	function mapColor(d){
            for(var i in data){
                if(data[i].state == d.id){
                    return color(data[i].death); 
                }
            }
        };

       	svgMap.selectAll(".state")
        	.data(path)
        	.enter().append("path")
        	.attr("class","state_path")
        	.attr("d",function(d){ return d.d;})
        	.style("fill", mapColor)
          .on("mouseover", mouseOvermap)
          .on("mouseout", mouseOutmap);
//margin 0 front siza
        function maptoolTip(d){
            for (var i in data){
            if(data[i].state == d.id){
                return "<h4>"+d.id+"</h4><table>"+
                  "<tr><td>Death</td><td>"+(data[i].death)+"</td></tr>"+"</table>"; 
                    //return "<p>Death rate per 100,000 population: " + d.id+ " %"+ "</p>"
            }
          }
        };

        function mouseOvermap(d){
           d3.select("#tooltip").transition().duration(200).style("opacity", .9);              
            d3.select("#tooltip").html(maptoolTip(d))  
            .style("left", (d3.event.pageX) + "px")     
            .style("top", (d3.event.pageY - 28) + "px");
        };

        function mouseOutmap(){
            d3.select("#tooltip")
            .transition().duration(500).style("opacity", 0);      
        };
};

	d3.csv('police_killings.csv', function (error, data) {
        	if (error) throw error;
        	var mapData = mapDataGenerate(data);
        	drawMap(mapData);
        	//console.log(mapData);
    }); 	*/
    </script>
 
  </body>

</html>